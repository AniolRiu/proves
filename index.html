<html>
  <head>
    <title>Socket chat</title>
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.3.3.js"></script>
    <script type="text/javascript" charset="utf-8">
		var ip;
		var socket;
		var can;
		var two_pi_rad = 2 * Math.PI;
		alert("yeye1");
		var connection_div_h = document.getElementById('form_connection').offsetHeight;
		alert("yeye2");
		// Wait for device API libraries to load
		document.addEventListener("deviceready", onDeviceReady, false);
		
		// device APIs are available
		function onDeviceReady() {
			// Sizing canvas ---
			can = document.getElementById("canvas");
			ctx = can.getContext("2d");
			screen_w = window.innerWidth;
			screen_h = window.innerHeight;
			can.width = screen_w;
			can.height = screen_h - connection_div_h;
			// ------
			alert(can.width + ' ' + can.height);
			ctx.clearRect( 0 , 0 , can.width, can.height );
			draw_round_button(50, 50, 30, 'green', 'up');
			
			can.addEventListener("touchstart",doTouchStart,false);
			
			
			$('#form_missatge').submit(function(){
				socket.emit('chat message', $('#m').val());
				$('#m').val('');
				return false;
			});
			$('#form_connexio').submit(function(){
				ip = $('#ip').val();
				socket = io('http://' + ip + ':3000');
				return false;
			});
			socket.on('chat message', function(msg){
				$('#messages').append($('<li>').text(msg));
			});
		}
		function doTouchStart(event){
			event.preventDefault();
			canvas_x = event.targetTouches[0].pageX;
			canvas_y = event.targetTouches[0].pageY - connection_div_h;
			alert("X=" + canvas_x + " Y=" + canvas_y);
			if (dist_btwn_points(canvas_x, canvas_y, 50, 50) < 30) socket.emit('chat message', "UP"); 
		}
		
		// Return distance between points
		function dist_btwn_points(x1, y1, x2, y2) {
			x = x1 - x2;
			x = x * x;
			y = y1 - y2;
			y = y * y;
			return Math.sqrt(x + y); 
		}
		
		function draw_round_button(x, y, rad, color, text) {	
			// Button drawing
			ctx.beginPath();
			ctx.arc(x,y,rad,0,two_pi_rad,false);
			ctx.fillStyle = color;
			ctx.fill();
			ctx.lineWidth = 2;
			ctx.strokeStyle = '#003300';
			ctx.stroke();
			
			// Create text
			var mida_lletra=20;
			ctx.fillStyle='black';
			ctx.font= mida_lletra + "px Droid Sans";
			ctx.fillText(text, x, y);
		}
	</script>
  </head>
  <body>
	<form id="form_connection">
      <input id="ip" autocomplete="off" /><button>Connecta</button>
    </form>
	<div id="pad">
		<canvas id="canvas"></canvas>
    </div>
    <ul id="messages"></ul>
    <form id="form_missatge">
      <input id="m" autocomplete="off" /><button>Envia</button>  
    </form>
    
    
	
  </body>
</html>
